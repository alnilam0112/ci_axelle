name: Deploy via SSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installation des d√©pendances et tests
      - name: Install dependencies & run tests
        run: |
          echo "üîπ Installing dependencies"

          # V√©rifie si package-lock.json existe
          if [ -f package-lock.json ]; then
            echo "üì¶ package-lock.json trouv√©, utilisation de npm ci"
            npm ci
          else
            echo "‚ö† package-lock.json manquant, utilisation de npm install"
            npm install
          fi

          echo "üîπ Running tests"
          npm test

      # 3Ô∏è‚É£ V√©rification du lint / syntaxe
      - name: Lint & syntax check
        run: |
          echo "üîπ Running linter"
          npm run lint
          # Pour PHP: php -l fichier.php

      # 4Ô∏è‚É£ V√©rification des fichiers critiques
      - name: Check critical files
        run: |
          if [ ! -f ./config/.env ]; then
            echo "‚ùå Fichier .env manquant, arr√™t du d√©ploiement"
            exit 1
          fi

      # 5Ô∏è‚É£ V√©rification de la branche
      - name: Ensure branch is main
        run: |
          if [ "${GITHUB_REF##*/}" != "main" ]; then
            echo "‚ùå D√©ploiement autoris√© uniquement depuis main"
            exit 1
          fi

      # 6Ô∏è‚É£ Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 7Ô∏è‚É£ Test de connexion SSH
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no axelle@lesacteursduweb.fr "echo '‚úî SSH works!'"

      # 8Ô∏è‚É£ D√©ploiement via rsync
      - name: Deploy files via rsync
        run: |
          rsync -avz --delete --exclude='.git' ./ axelle@lesacteursduweb.fr:/var/www/mon_site/

      # 9Ô∏è‚É£ Commandes √† distance (optionnel)
      - name: Run remote commands
        run: |
          ssh -o StrictHostKeyChecking=no axelle@lesacteursduweb.fr "
          cd /var/www/mon_site &&
          # Installer d√©pendances si n√©cessaire
          # npm install
          # Red√©marrer le serveur web
          sudo systemctl restart apache2
          echo '‚úî Deployment finished!'
          "
